<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>Nano Banana Pro Â· Art Edition</title>
  <style>
    :root {
      /* ä¿®æ”¹ï¼šèƒŒæ™¯è‰²ç¨å¾®è°ƒäº®ï¼Œæ›´æŸ”å’Œ */
      --bg-dark: #5F2E2E;
      --glass: rgba(30, 30, 35, 0.75);
      --glass-border: rgba(255, 255, 255, 0.08);
      --accent: #d4af37;
      /* é¦™æ§Ÿé‡‘ */
      --accent-glow: rgba(212, 175, 55, 0.4);
      --text-main: #e0e0e0;
      --text-muted: #999;
      /* ç¨å¾®æäº®ç°è‰²æ–‡å­— */
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      color: var(--text-main);
      background-color: var(--bg-dark);

      /* ä¿®æ”¹ï¼šå¢åŠ æ–œå‘ç½‘æ ¼çº¿è£…é¥° */
      background-image:
        radial-gradient(circle at 10% 20%, rgba(60, 20, 80, 0.4) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(20, 60, 80, 0.4) 0%, transparent 40%),
        repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.02) 0px, rgba(255, 255, 255, 0.02) 1px, transparent 1px, transparent 30px);

      background-attachment: fixed;
      font-family: "PingFang SC", "Helvetica Neue", Helvetica, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    @media (max-width: 900px) {
      body {
        height: auto;
        overflow: auto;
        padding-bottom: 40px;
      }
    }

    .app-container {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      height: 100%;
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
    }

    @media (max-width: 900px) {
      .app-container {
        grid-template-columns: 1fr;
        height: auto;
        display: block;
        padding: 16px;
      }
    }

    .panel-control {
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 24px;
      /* ç¨å¾®å¢åŠ å†…è¾¹è· */
      display: flex;
      flex-direction: column;
      gap: 18px;
      /* å¢åŠ é—´è· */
      overflow-y: auto;
      height: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 900px) {
      .panel-control {
        height: auto;
        margin-bottom: 20px;
      }
    }

    header {
      margin-bottom: 8px;
      border-bottom: 1px solid var(--glass-border);
      padding-bottom: 12px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      /* å¢å¤§æ ‡é¢˜ */
      font-weight: 300;
      letter-spacing: 2px;
      background: linear-gradient(90deg, #fff, #bbb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .author-info {
      font-size: 13px;
      /* å¢å¤§ä½œè€…ä¿¡æ¯ */
      color: var(--text-muted);
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
    }

    .author-highlight {
      color: var(--accent);
      cursor: pointer;
    }

    /* ä¿®æ”¹ï¼šå¢å¤§ Label å­—ä½“ */
    label {
      display: block;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }

    /* ä¿®æ”¹ï¼šå¢å¤§è¾“å…¥æ¡†å­—ä½“ */
    input[type="text"],
    textarea,
    select {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--glass-border);
      color: #fff;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 15px;
      /* 14px -> 15px */
      outline: none;
      transition: 0.3s;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
      line-height: 1.5;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.1);
      background: rgba(0, 0, 0, 0.5);
    }

    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .config-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .drop-zone {
      border: 1px dashed var(--glass-border);
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 14px;
      text-align: center;
      transition: 0.3s;
      cursor: pointer;
    }

    .drop-zone:hover {
      border-color: var(--text-muted);
      background: rgba(0, 0, 0, 0.4);
    }

    .drop-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* å¢å¤§ */

    .thumbs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .thumb {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      border: 1px solid var(--glass-border);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .thumb .del {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }

    .thumb:hover .del {
      opacity: 1;
    }

    /* æŒ‰é’® */
    .btn-main {
      background: linear-gradient(135deg, var(--accent), #b89628);
      color: #1a1a1a;
      border: none;
      height: 46px;
      /* ç¨å¾®å¢é«˜ */
      border-radius: 8px;
      font-weight: 700;
      font-size: 16px;
      /* å¢å¤§æŒ‰é’®æ–‡å­— */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px var(--accent-glow);
      transition: transform 0.1s, box-shadow 0.2s;
    }

    .btn-main:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px var(--accent-glow);
      filter: brightness(1.1);
    }

    .btn-main:active {
      transform: translateY(1px);
    }

    .btn-main[disabled] {
      filter: grayscale(1);
      opacity: 0.6;
      cursor: not-allowed;
    }

    .key-section {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px;
      border-radius: 8px;
    }

    .key-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    /* å¢å¤§ */
    .key-input-row {
      display: flex;
      gap: 6px;
    }

    .btn-sm {
      padding: 0 14px;
      height: 34px;
      font-size: 13px;
      /* å¢å¤§ */
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      color: #ccc;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn-sm:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .status-bar {
      font-size: 13px;
      text-align: center;
      color: var(--accent);
      min-height: 20px;
      margin-top: -6px;
    }

    /* å¢å¤§ */

    .panel-gallery {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .result-group {
      margin-bottom: 24px;
      animation: fadeIn 0.5s ease;
    }

    .result-meta {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* å¢å¤§ */
    .result-meta::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
    }

    /* å¤åˆ¶æŒ‰é’®æ ·å¼ */
    .btn-copy {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      color: var(--text-muted);
      border-radius: 4px;
      cursor: pointer;
      padding: 2px 8px;
      font-size: 12px;
      transition: 0.2s;
    }

    .btn-copy:hover {
      background: var(--accent);
      color: #1a1a1a;
      border-color: var(--accent);
    }

    .grid-imgs {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    .img-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      height: 280px;
      width: auto;
      background: #000;
      border: 1px solid var(--glass-border);
      transition: 0.3s;
      flex-shrink: 0;
    }

    @media (max-width: 600px) {
      .img-card {
        height: 180px;
      }
    }

    .img-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border-color: var(--text-muted);
    }

    .img-card img {
      height: 100%;
      width: auto;
      object-fit: contain;
      display: block;
    }

    .img-card img.error {
      padding: 40px;
      object-fit: contain;
      opacity: 0.5;
      filter: grayscale(1);
    }

    .overlay-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
      padding: 16px 12px 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      opacity: 1;
    }

    .btn-icon {
      background: rgba(255, 255, 255, 0.25);
      border: none;
      color: #fff;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .btn-icon:hover {
      background: var(--accent);
      color: #000;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .lightbox {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: rgba(0, 0, 0, 0.92);
      backdrop-filter: blur(5px);
      display: none;
      flex-direction: column;
    }

    .lightbox.show {
      display: flex;
    }

    .lb-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      color: #888;
      font-size: 15px;
    }

    /* å¢å¤§ */
    .lb-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .lb-main img {
      max-width: 100%;
      max-height: 100%;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
      object-fit: contain;
    }

    .lb-footer {
      padding: 20px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .lb-btn {
      background: transparent;
      border: 1px solid #444;
      color: #ccc;
      padding: 8px 18px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.2s;
      user-select: none;
      font-size: 14px;
    }

    .lb-btn:hover {
      border-color: #fff;
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .lb-btn.primary {
      border-color: var(--accent);
      color: var(--accent);
    }

    .lb-btn.primary:hover {
      background: var(--accent);
      color: #000;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-top-color: #000;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }

    /* History Button - Fixed in gallery area */
    .btn-history {
      position: fixed;
      top: 32px;
      right: 32px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid var(--glass-border);
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: 0.2s;
      z-index: 50;
      backdrop-filter: blur(4px);
    }

    .btn-history:hover {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    @media (max-width: 900px) {
      .btn-history {
        top: auto;
        bottom: 20px;
        right: 20px;
      }
    }

    /* History Modal */
    .history-modal {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .history-modal.show {
      display: flex;
    }

    .history-header {
      padding: 20px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-header h3 {
      margin: 0;
      font-size: 18px;
      color: #fff;
    }

    .history-close {
      background: none;
      border: none;
      color: #aaa;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 12px;
    }

    .history-close:hover {
      color: #fff;
    }

    .history-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .history-item {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .history-item-thumb {
      width: 120px;
      height: 68px;
      border-radius: 6px;
      overflow: hidden;
      background: #000;
      flex-shrink: 0;
    }

    .history-item-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .history-item-info {
      flex: 1;
      min-width: 0;
    }

    .history-item-time {
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .history-item-taskid {
      font-size: 11px;
      color: var(--text-muted);
      font-family: monospace;
      word-break: break-all;
    }

    .history-item-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-top: 4px;
      display: inline-block;
    }

    .history-item-status.completed {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .history-item-status.pending {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    .history-item-status.failed {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .history-item-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .history-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      color: #ccc;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: 0.2s;
    }

    .history-btn:hover {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .history-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--glass-border);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
    }

    .pagination-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      color: #ccc;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.2s;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--accent);
      color: #000;
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .pagination-info {
      color: var(--text-muted);
      font-size: 13px;
    }

    .history-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 60px 20px;
      font-size: 14px;
    }
  </style>
</head>

<body>

  <div class="app-container">
    <aside class="panel-control">
      <header>
        <h1>NANO BANANA PRO</h1>
        <div class="author-info">
          <span>å›½å†…å¯ç”¨ ç®€å•å¿«æ·</span>
          <span>ä½œè€…: Gorden Sun <span class="author-highlight" onclick="copyWx()">å¾®ä¿¡: duge360</span></span>
        </div>
      </header>

      <div>
        <label>åˆ›æ„æè¿° (Prompt)</label>
        <textarea id="prompt" placeholder="è¾“å…¥å›¾ç‰‡æè¿°ï¼Œæ”¯æŒä¸­è‹±æ–‡"></textarea>
      </div>

      <div class="config-grid-3">
        <div>
          <label>æ¨¡å‹</label>
          <select id="modelSelect">
            <option value="nano-banana-pro" selected>æ›´ç¨³å®š</option>
            <option value="nano-banana-pro-vt">å¤‡ç”¨</option>
          </select>
        </div>
        <div>
          <label>ç”»å¹…æ¯”ä¾‹</label>
          <select id="ratioSelect">
            <option value="auto">è‡ªåŠ¨</option>
            <option value="1:1">1:1</option>
            <option value="16:9">16:9</option>
            <option value="9:16">9:16</option>
            <option value="4:3">4:3</option>
            <option value="3:4">3:4</option>
            <option value="3:2">3:2</option>
            <option value="2:3">2:3</option>
            <option value="5:4">5:4</option>
            <option value="4:5">4:5</option>
            <option value="21:9">21:9</option>
          </select>
        </div>
        <div>
          <label>åˆ†è¾¨ç‡</label>
          <select id="sizeSelect">
            <option value="1K">1K æ ‡å‡†</option>
            <option value="2K">2K é«˜æ¸…</option>
            <option value="4K" selected>4K è¶…æ¸…</option>
          </select>
        </div>
      </div>

      <div>
        <label>å‚è€ƒå›¾ç‰‡æˆ–è¦ç¼–è¾‘çš„å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
        <div class="drop-zone" id="drop">
          <span class="drop-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>
          <input id="file" type="file" accept="image/*" multiple hidden>
        </div>
        <div id="thumbs" class="thumbs"></div>
      </div>

      <div class="key-section">
        <div class="key-label">ç¬¬3æ­¥ï¼šè¾“å…¥Key (å¿…å¡«ï¼Œè”ç³»ä½œè€…å¾®ä¿¡ <b>duge360</b> è´­ä¹°ï¼Œ0.3å…ƒ/æ¬¡ï¼Œä»·æ ¼å¯èƒ½å˜åŠ¨)</div>
        <div class="key-input-row">
          <input type="text" id="userKey" placeholder="sk-..." style="height:34px;">
          <button class="btn-sm" id="saveKey">ä¿å­˜</button>
          <button class="btn-sm" id="queryCredits">æŸ¥è¯¢å‰©ä½™</button>
        </div>
      </div>

      <div class="status-bar" id="status"></div>

      <button class="btn-main" id="go">
        <span class="spinner" id="spin"></span>
        <span id="btnText">ç”Ÿæˆ</span>
      </button>
    </aside>

    <main class="panel-gallery" id="gallery">
    </main>
  </div>

  <!-- Fixed History Button -->
  <button class="btn-history" onclick="openHistory()">ğŸ“‹ å†å²</button>

  <!-- History Modal -->
  <div class="history-modal" id="historyModal">
    <div class="history-header">
      <h3>ğŸ“‹ å†å²ç”Ÿæˆè®°å½•</h3>
      <button class="history-close" onclick="closeHistory()">âœ• å…³é—­</button>
    </div>
    <div class="history-body">
      <div class="history-list" id="historyList"></div>
    </div>
    <div class="history-footer">
      <button class="pagination-btn" id="historyPrev" onclick="historyPrevPage()">â† ä¸Šä¸€é¡µ</button>
      <span class="pagination-info" id="historyPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
      <button class="pagination-btn" id="historyNext" onclick="historyNextPage()">ä¸‹ä¸€é¡µ â†’</button>
    </div>
  </div>

  <div class="lightbox" id="lightbox">
    <div class="lb-header">
      <span id="lbInfo">Preview</span>
      <span style="cursor:pointer" id="lbClose">âœ• å…³é—­</span>
    </div>
    <div class="lb-main">
      <img id="lbImg" src="" crossorigin="anonymous">
    </div>
    <div class="lb-footer">
      <button class="lb-btn" id="lbPrev">â† å‰ä¸€å¼ </button>
      <button class="lb-btn primary" id="lbDownBtn">â†“ ä¸‹è½½åŸå›¾</button>
      <button class="lb-btn" id="lbNext">åä¸€å¼  â†’</button>
    </div>
  </div>

  <script>
    ; (() => {
      // ====== é…ç½®ä¸å¸¸é‡ ======

      // ğŸ”´ ğŸ”´ ğŸ”´ å·²é…ç½®ä¸ºæ‚¨çš„å…¬å¼€åŸŸå ğŸ”´ ğŸ”´ ğŸ”´
      const PUBLIC_R2_DOMAIN = 'https://cdn.gordensun.com/bananaproimage';

      // API ç«¯ç‚¹ (ç»Ÿä¸€ä½¿ç”¨åŒä¸€ä¸ªæ¥å£ï¼Œæ¨¡å‹é€šè¿‡ payload æŒ‡å®š)
      const ENDPOINT = 'https://grsai.dakka.com.cn/v1/draw/nano-banana';
      const RESULT_ENDPOINT = 'https://grsai.dakka.com.cn/v1/draw/result';

      // ç‹¬ç«‹ç¼“å­˜ Keys (grsai_pro)
      const STORE_KEY = 'grsai_pro:key';
      const STORE_RATIO = 'grsai_pro:ratio';
      const STORE_SIZE = 'grsai_pro:size';
      const STORE_MODEL = 'grsai_pro:model';
      const HISTORY_KEY = 'grsai_pro:history';

      // è½®è¯¢é…ç½®
      const POLL_INTERVAL = 5000; // 5ç§’
      const MAX_POLL_ATTEMPTS = 120; // æœ€å¤šè½®è¯¢120æ¬¡ (10åˆ†é’Ÿ)

      // å†å²åˆ†é¡µçŠ¶æ€
      let historyPage = 1;
      const historyPerPage = 10;

      // ====== DOM å…ƒç´  ======
      const el = (id) => document.getElementById(id);
      const ui = {
        prompt: el('prompt'),
        model: el('modelSelect'),
        ratio: el('ratioSelect'),
        size: el('sizeSelect'),
        key: el('userKey'),
        saveKey: el('saveKey'),
        queryCredits: el('queryCredits'),
        drop: el('drop'),
        fileInput: el('file'),
        thumbs: el('thumbs'),
        go: el('go'),
        btnText: el('btnText'),
        spin: el('spin'),
        status: el('status'),
        gallery: el('gallery'),
        lb: el('lightbox'),
        lbMain: document.querySelector('.lb-main'),
        lbImg: el('lbImg'),
        lbInfo: el('lbInfo'),
        lbDownBtn: el('lbDownBtn'),
        lbPrev: el('lbPrev'),
        lbNext: el('lbNext'),
        lbClose: el('lbClose'),
        historyModal: el('historyModal'),
        historyList: el('historyList'),
        historyPrev: el('historyPrev'),
        historyNext: el('historyNext'),
        historyPageInfo: el('historyPageInfo')
      };

      let refImages = []; // å‚è€ƒå›¾æ•°æ®
      let currentLbUrl = ''; // å½“å‰å¤§å›¾URL
      let currentImgIndex = -1; // å½“å‰å¤§å›¾åœ¨æ‰€æœ‰å›¾ç‰‡ä¸­çš„ç´¢å¼•
      let viewingFromHistory = false; // æ ‡è®°æ˜¯å¦ä»å†å²è®°å½•æŸ¥çœ‹å¤§å›¾

      // ====== åˆå§‹åŒ–ï¼šåŠ è½½ç¼“å­˜ ======
      ui.key.value = localStorage.getItem(STORE_KEY) || '';
      if (localStorage.getItem(STORE_RATIO)) ui.ratio.value = localStorage.getItem(STORE_RATIO);
      if (localStorage.getItem(STORE_MODEL)) ui.model.value = localStorage.getItem(STORE_MODEL);

      // åˆ†è¾¨ç‡åˆå§‹åŒ–ï¼šä¼˜å…ˆç¼“å­˜ï¼Œæ— ç¼“å­˜åˆ™é»˜è®¤ 4K
      ui.size.value = localStorage.getItem(STORE_SIZE) || '4K';

      // ç›‘å¬ä¿å­˜
      ui.saveKey.onclick = () => {
        localStorage.setItem(STORE_KEY, ui.key.value.trim());
        msg('Key å·²ä¿å­˜');
      };

      // æŸ¥è¯¢å‰©ä½™æ¬¡æ•°
      ui.queryCredits.onclick = async () => {
        const key = ui.key.value.trim();
        if (!key) return msg('è¯·å…ˆå¡«å†™ Key', true);

        msg('æ­£åœ¨æŸ¥è¯¢å‰©ä½™æ¬¡æ•°...');
        try {
          const res = await fetch('https://grsai.dakka.com.cn/client/openapi/getAPIKeyCredits', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiKey: key })
          });
          const data = await res.json();
          if (data.code === 0 && data.data && typeof data.data.credits === 'number') {
            const credits = data.data.credits;
            const remainingUses = Math.floor(credits / 1800);
            msg(`å‰©ä½™æ¬¡æ•°: ${remainingUses} æ¬¡`);
          } else {
            msg('æŸ¥è¯¢å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'), true);
          }
        } catch (e) {
          msg('æŸ¥è¯¢å¤±è´¥: ' + e.message, true);
        }
      };
      ui.ratio.onchange = () => localStorage.setItem(STORE_RATIO, ui.ratio.value);
      ui.size.onchange = () => localStorage.setItem(STORE_SIZE, ui.size.value);
      ui.model.onchange = () => localStorage.setItem(STORE_MODEL, ui.model.value);

      // ====== äº¤äº’é€»è¾‘ï¼šæ–‡ä»¶ä¸Šä¼  ======
      ui.drop.onclick = () => ui.fileInput.click();
      ui.fileInput.onchange = (e) => handleFiles(e.target.files);

      // æ‹–æ‹½æ”¯æŒ
      ui.drop.ondragover = (e) => { e.preventDefault(); ui.drop.style.background = 'rgba(212,175,55,0.2)'; };
      ui.drop.ondragleave = (e) => { e.preventDefault(); ui.drop.style.background = ''; };
      ui.drop.ondrop = (e) => {
        e.preventDefault();
        ui.drop.style.background = '';
        handleFiles(e.dataTransfer.files);
      };

      async function handleFiles(files) {
        const list = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (!list.length) return;
        if (refImages.length + list.length > 5) return msg('æœ€å¤šä¸Šä¼  5 å¼ å‚è€ƒå›¾', true);

        for (let f of list) {
          const b64 = await toBase64(f);
          refImages.push(b64);
        }
        renderThumbs();
      }

      function renderThumbs() {
        ui.thumbs.innerHTML = refImages.map((src, i) => `
      <div class="thumb">
        <img src="${src}">
        <div class="del" onclick="removeThumb(${i})">âœ•</div>
      </div>
    `).join('');
      }
      window.removeThumb = (i) => { refImages.splice(i, 1); renderThumbs(); };

      // ====== åŸŸåä¿®æ­£å‡½æ•° (æ™ºèƒ½å¤„ç†è·¯å¾„) ======
      function fixR2Url(rawUrl) {
        if (!rawUrl) return '';
        if (!PUBLIC_R2_DOMAIN) return rawUrl;

        try {
          const u = new URL(rawUrl);
          if (u.hostname.includes('r2.cloudflarestorage.com')) {
            let path = u.pathname;
            if (path.startsWith('/bananaproimage/')) {
              path = path.replace('/bananaproimage/', '/');
            }
            const domain = PUBLIC_R2_DOMAIN.replace(/\/$/, '');
            return domain + path;
          }
        } catch (e) { console.error('URL replace error', e); }
        return rawUrl;
      }

      // ====== å†å²è®°å½•ç®¡ç† ======
      function loadHistory() {
        try {
          const data = localStorage.getItem(HISTORY_KEY);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
          return [];
        }
      }

      function saveHistory(history) {
        try {
          localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
          console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
        }
      }

      function addHistoryItem(taskId, status = 'pending', imageUrls = [], prompt = '') {
        const history = loadHistory();
        const existingIndex = history.findIndex(h => h.taskId === taskId);
        const existing = existingIndex >= 0 ? history[existingIndex] : null;

        // ä¿ç•™å·²æœ‰æ•°æ®ï¼šå¦‚æœæ–°ä¼ å…¥çš„æ˜¯ç©ºå€¼ï¼Œåˆ™ä½¿ç”¨æ—§å€¼
        const finalImageUrls = imageUrls.length > 0 ? imageUrls : (existing?.imageUrls || []);
        const finalPrompt = prompt || (existing?.prompt || '');

        const item = {
          taskId,
          status,
          imageUrls: finalImageUrls,
          prompt: finalPrompt,
          createdAt: existing ? existing.createdAt : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        if (existingIndex >= 0) {
          history[existingIndex] = item;
        } else {
          history.unshift(item);
        }
        saveHistory(history);
        return item;
      }

      function renderHistoryList() {
        const history = loadHistory();
        const totalPages = Math.max(1, Math.ceil(history.length / historyPerPage));
        historyPage = Math.min(historyPage, totalPages);

        const start = (historyPage - 1) * historyPerPage;
        const pageItems = history.slice(start, start + historyPerPage);

        if (pageItems.length === 0) {
          ui.historyList.innerHTML = '<div class="history-empty">æš‚æ— å†å²è®°å½•</div>';
        } else {
          ui.historyList.innerHTML = pageItems.map(item => {
            const time = new Date(item.createdAt).toLocaleString();
            // åŒºåˆ†çŠ¶æ€ï¼šcompleted, pending, timeout(å¯åˆ·æ–°), failed(çœŸæ­£å¤±è´¥), rejected(å®¡æ ¸æœªé€šè¿‡)
            const isCompleted = item.status === 'completed' && item.imageUrls && item.imageUrls.length > 0;
            const isRealFailed = item.status === 'failed';  // çœŸæ­£çš„APIå¤±è´¥
            const isRejected = item.status === 'rejected';  // æˆåŠŸä½†æ— å›¾ç‰‡ï¼ˆå®¡æ ¸ï¼‰
            const isTimeout = item.status === 'timeout';     // æœ¬åœ°è½®è¯¢è¶…æ—¶
            const isPending = item.status === 'pending';

            let statusClass, statusText;
            if (isCompleted) {
              statusClass = 'completed';
              statusText = 'å·²å®Œæˆ';
            } else if (isRealFailed) {
              statusClass = 'failed';
              statusText = 'å·²å¤±è´¥';
            } else if (isRejected) {
              statusClass = 'pending';  // ç”¨pendingæ ·å¼ï¼Œå› ä¸ºå¯ä»¥åˆ·æ–°
              statusText = 'æ— å›¾ç‰‡(å®¡æ ¸)';
            } else if (isTimeout) {
              statusClass = 'pending';
              statusText = 'è¶…æ—¶(å¯åˆ·æ–°)';
            } else {
              statusClass = 'pending';
              statusText = 'å¤„ç†ä¸­...';
            }

            const hasImages = item.imageUrls && item.imageUrls.length > 0;
            // é™¤äº†å·²å®Œæˆçš„ï¼Œå…¶ä»–çŠ¶æ€éƒ½å¯ä»¥åˆ·æ–°
            const canRefresh = !isCompleted;
            let thumbText = 'ç­‰å¾…ç»“æœ...';
            if (isRealFailed) thumbText = 'ç”Ÿæˆå¤±è´¥';
            if (isRejected) thumbText = 'å®¡æ ¸æœªé€šè¿‡';
            const thumbHtml = hasImages
              ? `<img src="${item.imageUrls[0]}" loading="lazy">`
              : '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:12px;">' + thumbText + '</div>';

            return `
          <div class="history-item" data-task-id="${item.taskId}">
            <div class="history-item-thumb">${thumbHtml}</div>
            <div class="history-item-info">
              <div class="history-item-time">${time}</div>
              <div class="history-item-taskid">Task: ${item.taskId}</div>
              <div class="history-item-status ${statusClass}">${statusText}</div>
            </div>
            <div class="history-item-actions">
              ${canRefresh ? `<button class="history-btn" onclick="refreshHistoryItem('${item.taskId}')">åˆ·æ–°</button>` : ''}
              ${hasImages ? `<button class="history-btn" onclick="viewHistoryImages('${item.taskId}')">æŸ¥çœ‹</button>` : ''}
            </div>
          </div>
        `;
          }).join('');
        }

        ui.historyPageInfo.textContent = `ç¬¬ ${historyPage} é¡µ / å…± ${totalPages} é¡µ`;
        ui.historyPrev.disabled = historyPage <= 1;
        ui.historyNext.disabled = historyPage >= totalPages;
      }

      window.openHistory = () => {
        historyPage = 1;
        renderHistoryList();
        ui.historyModal.classList.add('show');
      };

      window.closeHistory = () => {
        ui.historyModal.classList.remove('show');
      };

      window.historyPrevPage = () => {
        if (historyPage > 1) {
          historyPage--;
          renderHistoryList();
        }
      };

      window.historyNextPage = () => {
        const history = loadHistory();
        const totalPages = Math.ceil(history.length / historyPerPage);
        if (historyPage < totalPages) {
          historyPage++;
          renderHistoryList();
        }
      };

      window.refreshHistoryItem = async (taskId) => {
        const key = ui.key.value.trim();
        if (!key) return msg('è¯·å¡«å†™ Key', true);

        try {
          // ä½¿ç”¨é™é»˜æ¨¡å¼ï¼Œä¸æ›´æ–°ä¸»ç•Œé¢çŠ¶æ€æ 
          await pollTaskStatus(taskId, key, 1, true);
        } catch (e) {
          console.error('åˆ·æ–°å¤±è´¥:', e);
        } finally {
          // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½åˆ·æ–°å†å²åˆ—è¡¨ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
          renderHistoryList();
        }
      };

      window.viewHistoryImages = (taskId) => {
        const history = loadHistory();
        const item = history.find(h => h.taskId === taskId);
        if (item && item.imageUrls && item.imageUrls.length > 0) {
          // è®¾ç½®æ ‡è®°ï¼Œè¡¨ç¤ºä»å†å²è®°å½•æ‰“å¼€
          viewingFromHistory = true;
          // å…ˆéšè—å†å²å¼¹çª—ï¼ˆä¸å…³é—­ï¼Œè¿™æ ·å…³é—­å¤§å›¾æ—¶å¯ä»¥è¿”å›ï¼‰
          ui.historyModal.style.visibility = 'hidden';
          // ç›´æ¥è®¾ç½®å¤§å›¾URL
          currentLbUrl = item.imageUrls[0];
          ui.lbImg.src = currentLbUrl;
          ui.lb.classList.add('show');
          ui.lbInfo.textContent = 'History Preview';
        }
      };

      // ====== å¼‚æ­¥ä»»åŠ¡è½®è¯¢ ======
      async function pollTaskStatus(taskId, key, maxAttempts = MAX_POLL_ATTEMPTS, silent = false) {
        let attempts = 0;

        while (attempts < maxAttempts) {
          attempts++;

          try {
            const res = await fetch(RESULT_ENDPOINT, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + key
              },
              body: JSON.stringify({ id: taskId })
            });

            if (!res.ok) {
              let errStr = `Error ${res.status}`;
              try { const j = await res.json(); if (j.msg) errStr = j.msg; } catch (e) { }
              throw new Error(errStr);
            }

            const data = await res.json();
            console.log(`è½®è¯¢ç¬¬ ${attempts} æ¬¡, å®Œæ•´å“åº”:`, JSON.stringify(data, null, 2));

            // ä»»åŠ¡ä¸å­˜åœ¨
            if (data.code === -22) {
              if (!silent) msg(`ä»»åŠ¡æ’é˜Ÿä¸­... (${attempts}/${maxAttempts})`);
              await new Promise(resolve => setTimeout(resolve, POLL_INTERVAL));
              continue;
            }

            if (data.code === 0 && data.data) {
              const task = data.data;
              const status = task.status;
              const progress = task.progress || 0;

              // æˆåŠŸå®Œæˆ
              if (status === 'succeeded') {
                const urls = (task.results || []).map(r => fixR2Url(r.url)).filter(u => u);
                if (urls.length > 0) {
                  addHistoryItem(taskId, 'completed', urls);
                  return { success: true, urls };
                } else {
                  // æˆåŠŸä½†æ— å›¾ç‰‡ï¼ˆå¯èƒ½æ˜¯å®¡æ ¸ï¼‰
                  addHistoryItem(taskId, 'rejected', []);
                  return { success: true, urls: [], rejected: true };
                }
              }

              // å¤±è´¥
              if (status === 'failed') {
                addHistoryItem(taskId, 'failed', []);
                const reason = task.failure_reason || task.error || 'ç”Ÿæˆå¤±è´¥';
                return { success: false, failed: true, reason };
              }

              // è¿›è¡Œä¸­
              if (status === 'running') {
                addHistoryItem(taskId, 'pending', []);
                if (!silent) msg(`ç”Ÿæˆä¸­... ${progress}% (${attempts}/${maxAttempts})`);
              }
            }

          } catch (err) {
            console.error(`è½®è¯¢å¤±è´¥ (å°è¯• ${attempts}):`, err);
            if (attempts >= maxAttempts) {
              addHistoryItem(taskId, 'timeout', []);
              throw err;
            }
          }

          if (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, POLL_INTERVAL));
          }
        }

        // æœ¬åœ°è½®è¯¢è¶…æ—¶
        addHistoryItem(taskId, 'timeout', []);
        if (!silent) throw new Error('è½®è¯¢è¶…æ—¶ï¼Œè¯·ç¨ååœ¨å†å²è®°å½•ä¸­åˆ·æ–°');
        return { success: false, urls: [] };
      }

      // ====== æ ¸å¿ƒï¼šç”Ÿæˆè¯·æ±‚ (å¼‚æ­¥æ¨¡å¼) ======
      ui.go.onclick = async () => {
        const prompt = ui.prompt.value.trim();
        const key = ui.key.value.trim();
        const model = ui.model.value;

        if (!prompt) return msg('è¯·è¾“å…¥ä¸€äº›æè¿°...', true);
        if (!key) return msg('è¯·å¡«å†™ Key', true);

        setLoading(true);
        msg('æ­£åœ¨æäº¤ç”Ÿæˆä»»åŠ¡...');

        try {
          const payload = {
            model: model,
            prompt: prompt,
            aspectRatio: ui.ratio.value,
            imageSize: ui.size.value,
            urls: refImages.length ? refImages : undefined,
            webHook: "-1",  // å¼‚æ­¥æ¨¡å¼ï¼šè¿”å›ä»»åŠ¡ID
            shutProgress: true
          };

          const res = await fetch(ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + key,
              'oss-id': '692b1ce0469719c8c4c5af05',
              'oss-path': 'bananaproimage'
            },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            let errMessage = `HTTP ${res.status}`;
            try {
              const errData = await res.json();
              if (errData.msg) errMessage = errData.msg;
            } catch (e) { }
            throw new Error(errMessage);
          }

          const data = await res.json();
          console.log('Async API Response:', data);

          if (data.code === 0 && data.data?.id) {
            const taskId = data.data.id;
            msg(`ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç­‰å¾…ç”Ÿæˆç»“æœ... (Task ID: ${taskId.slice(0, 8)}...)`);

            // æ·»åŠ åˆ°å†å²è®°å½•
            addHistoryItem(taskId, 'pending', [], prompt);

            try {
              const result = await pollTaskStatus(taskId, key);
              if (result.success && result.urls.length > 0) {
                msg('åˆ›ä½œå®Œæˆ');
                addGalleryGroup(result.urls, prompt);
              } else if (result.rejected) {
                msg('å†…å®¹å®¡æ ¸æœªé€šè¿‡ï¼Œè¯·ä¿®æ”¹æè¿°åé‡è¯•', true);
              } else if (result.failed) {
                msg(`ç”Ÿæˆå¤±è´¥: ${result.reason}`, true);
              } else {
                throw new Error('æœªè¿”å›æœ‰æ•ˆå›¾ç‰‡');
              }
            } catch (pollErr) {
              msg(`${pollErr.message}`, true);
            }
          } else {
            throw new Error(data.msg || 'æœªè¿”å›æœ‰æ•ˆçš„ä»»åŠ¡ID');
          }

        } catch (err) {
          console.error(err);
          msg('é”™è¯¯: ' + (err.message || 'æœªçŸ¥é”™è¯¯'), true);
        } finally {
          setLoading(false);
        }
      };

      // ====== ç•Œé¢æ›´æ–° ======
      function setLoading(ing) {
        if (ing) {
          ui.go.disabled = true;
          ui.spin.style.display = 'inline-block';
          ui.btnText.textContent = 'æ­£åœ¨ç»˜åˆ¶...';
        } else {
          ui.go.disabled = false;
          ui.spin.style.display = 'none';
          ui.btnText.textContent = 'ç”Ÿæˆ';
        }
      }

      function msg(txt, err = false) {
        ui.status.textContent = txt;
        ui.status.style.color = err ? '#ff6b6b' : 'var(--accent)';
      }

      function addGalleryGroup(urls, prompt) {
        const time = new Date().toLocaleTimeString();

        // åˆ›å»ºå®¹å™¨
        const group = document.createElement('div');
        group.className = 'result-group';

        // åˆ›å»º meta ä¿¡æ¯
        const meta = document.createElement('div');
        meta.className = 'result-meta';
        meta.innerHTML = `
      <span>${time}</span>
      <span style="opacity:0.6; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${prompt}</span>
      <button class="btn-copy" data-text="${prompt.replace(/"/g, '&quot;')}" onclick="copyFromData(this)">å¤åˆ¶</button>
    `;
        group.appendChild(meta);

        // åˆ›å»ºå›¾ç‰‡ç½‘æ ¼
        const grid = document.createElement('div');
        grid.className = 'grid-imgs';

        urls.forEach(url => {
          const card = document.createElement('div');
          card.className = 'img-card';
          card.onclick = () => openLightbox(url);

          const img = document.createElement('img');
          img.crossOrigin = 'anonymous';

          // å…³é”®ä¿®å¤ï¼šå›¾ç‰‡åŠ è½½å®Œæˆåå¼ºåˆ¶è§¦å‘é‡ç»˜
          img.onload = function () {
            // æ–¹æ³•1: visibility åˆ‡æ¢ï¼ˆå¯¹ WebView æœ€æœ‰æ•ˆï¼‰
            this.style.visibility = 'hidden';
            void this.offsetHeight;
            this.style.visibility = 'visible';

            // æ–¹æ³•2: è§¦å‘çˆ¶å®¹å™¨é‡ç»˜
            card.style.opacity = '0.99';
            setTimeout(() => {
              card.style.opacity = '1';
            }, 0);
          };

          img.onerror = function () {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIi8+PGxpbmUgeDE9IjEyIiB5MT0iOCIgeDI9IjEyIiB5Mj0iMTIiLz48bGluZSB4MT0iMTIiIHkxPSIxNiIgeDI9IjEyLjAxIiB5Mj0iMTYiLz48L3N2Zz4=';
            this.className = 'error';
          };

          // è®¾ç½® srcï¼ˆæ”¾åœ¨äº‹ä»¶ç»‘å®šåï¼‰
          img.src = url;

          const overlay = document.createElement('div');
          overlay.className = 'overlay-actions';
          const dlBtn = document.createElement('button');
          dlBtn.className = 'btn-icon';
          dlBtn.innerHTML = 'â†“';
          dlBtn.onclick = (e) => { e.stopPropagation(); download(url); };
          overlay.appendChild(dlBtn);

          card.appendChild(img);
          card.appendChild(overlay);
          grid.appendChild(card);
        });

        group.appendChild(grid);

        // å…ˆè®¾ç½® visibility hiddenï¼Œæ’å…¥åå†æ˜¾ç¤ºï¼Œå¼ºåˆ¶é‡ç»˜
        group.style.visibility = 'hidden';
        ui.gallery.insertBefore(group, ui.gallery.firstChild);

        // å¼ºåˆ¶é‡æ’åæ˜¾ç¤º
        void group.offsetHeight;
        group.style.visibility = 'visible';

        // å»¶è¿Ÿå†æ¬¡å¼ºåˆ¶é‡ç»˜
        setTimeout(() => {
          group.style.display = 'none';
          void group.offsetHeight;
          group.style.display = '';

          // æ»šåŠ¨åˆ°ç»“æœ
          if (window.innerWidth <= 900) {
            group.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);

        // 500ms åæœ€ç»ˆä¿åº•é‡ç»˜
        setTimeout(() => {
          const imgs = group.querySelectorAll('img');
          imgs.forEach(img => {
            img.style.visibility = 'hidden';
            void img.offsetHeight;
            img.style.visibility = 'visible';
          });
        }, 500);
      }

      // ====== Lightbox é€»è¾‘ä¼˜åŒ– (æ”¯æŒè·¨æ‰¹æ¬¡åˆ‡æ¢ä¸é”®ç›˜) ======

      // è·å–å½“å‰é¡µé¢æ‰€æœ‰å›¾ç‰‡å…ƒç´ ï¼ˆDOMé¡ºåºï¼‰
      function getAllImages() {
        return Array.from(document.querySelectorAll('.panel-gallery .img-card img'));
      }

      // æ‰“å¼€å¤§å›¾
      window.openLightbox = (url) => {
        viewingFromHistory = false;  // ä»å›¾åº“æŸ¥çœ‹æ—¶é‡ç½®æ ‡è®°
        const imgs = getAllImages();
        // æŸ¥æ‰¾å½“å‰å›¾ç‰‡ç´¢å¼•ï¼ˆæ ¹æ®srcåŒ¹é…ï¼‰
        currentImgIndex = imgs.findIndex(img => img.src === url);
        updateLightboxImage();
        ui.lb.classList.add('show');
      };

      // åˆ·æ–°å¤§å›¾æ˜¾ç¤º
      function updateLightboxImage() {
        const imgs = getAllImages();
        if (currentImgIndex < 0 || currentImgIndex >= imgs.length) return;

        const imgObj = imgs[currentImgIndex];
        currentLbUrl = imgObj.src;
        ui.lbImg.src = currentLbUrl;
        ui.lbInfo.textContent = `Preview (${currentImgIndex + 1} / ${imgs.length})`;
      }

      // åˆ‡æ¢é€»è¾‘
      function prevImage() {
        const imgs = getAllImages();
        if (currentImgIndex > 0) {
          currentImgIndex--;
          updateLightboxImage();
        }
      }

      function nextImage() {
        const imgs = getAllImages();
        if (currentImgIndex < imgs.length - 1) {
          currentImgIndex++;
          updateLightboxImage();
        }
      }

      // å…³é—­é€»è¾‘
      function closeLightbox() {
        ui.lb.classList.remove('show');
        // å¦‚æœæ˜¯ä»å†å²è®°å½•æ‰“å¼€çš„ï¼Œå…³é—­å¤§å›¾åè¿”å›å†å²åˆ—è¡¨
        if (viewingFromHistory) {
          viewingFromHistory = false;
          ui.historyModal.style.visibility = 'visible';
        }
      }

      // äº‹ä»¶ç»‘å®š: æŒ‰é’®
      ui.lbPrev.onclick = (e) => { e.stopPropagation(); prevImage(); };
      ui.lbNext.onclick = (e) => { e.stopPropagation(); nextImage(); };
      ui.lbClose.onclick = closeLightbox;
      ui.lbDownBtn.onclick = () => { if (currentLbUrl) download(currentLbUrl); };

      // äº‹ä»¶ç»‘å®š: æ™ºèƒ½ç‚¹å‡»ç©ºç™½å…³é—­
      ui.lb.onclick = (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯èƒŒæ™¯å±‚(ui.lb)ã€ä¸»å®¹å™¨(lbMain)ã€æˆ–å¤´éƒ¨åº•éƒ¨ï¼Œè€Œéå›¾ç‰‡æœ¬èº«å’ŒæŒ‰é’®
        // ç®€å•åˆ¤æ–­: åªè¦ä¸æ˜¯ IMG æˆ– BUTTON æ ‡ç­¾ï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯ç©ºç™½åŒºåŸŸ
        const tag = e.target.tagName;
        if (tag !== 'IMG' && tag !== 'BUTTON') {
          closeLightbox();
        }
      };

      // äº‹ä»¶ç»‘å®š: é”®ç›˜ (Esc, Left, Right)
      document.addEventListener('keydown', (e) => {
        // å…ˆæ£€æŸ¥å¤§å›¾æ¡†æ˜¯å¦æ˜¾ç¤º
        if (ui.lb.classList.contains('show')) {
          switch (e.key) {
            case 'Escape': closeLightbox(); break;
            case 'ArrowLeft': if (!viewingFromHistory) prevImage(); break;
            case 'ArrowRight': if (!viewingFromHistory) nextImage(); break;
          }
          return;
        }

        // ESC å…³é—­å†å²å¼¹çª—
        if (e.key === 'Escape' && ui.historyModal.classList.contains('show')) {
          closeHistory();
        }
      });

      // ä¸‹è½½åŠŸèƒ½
      window.download = async (url) => {
        msg('æ­£åœ¨ä¸‹è½½åŸå›¾...');
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error('Network error');
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = `art-${Date.now()}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();

          setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
          msg('ä¸‹è½½å·²è§¦å‘');
        } catch (e) {
          console.warn('Fallback to link', e);
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.download = `art-${Date.now()}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          msg('å·²åœ¨æ–°çª—å£æ‰“å¼€');
        }
      };

      window.copyWx = () => {
        navigator.clipboard.writeText('duge360');
        msg('å¾®ä¿¡å·å·²å¤åˆ¶');
      };

      window.copyFromData = (btn) => {
        const txt = btn.getAttribute('data-text');
        navigator.clipboard.writeText(txt).then(() => {
          const originalText = btn.innerText;
          btn.innerText = 'å·²å¤åˆ¶';
          setTimeout(() => btn.innerText = originalText, 1500);
        });
      };

      const toBase64 = file => new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });

    })();
  </script>
</body>

</html>
